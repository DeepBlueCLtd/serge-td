(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{102:function(e){e.exports={main:{name:"main",remote:null,live:!1,retry:!1},messages:{name:"messages",remote:"http://localhost:8080/db/messages",live:!0,retry:!1},"message-types":{name:"message-types",remote:null,live:!1,retry:!1},"rewind-points":{name:"rewind-points",remote:"http://localhost:8080//db/rewind-points",live:!0,retry:!1}}},115:function(e,t,a){"use strict";a.r(t);var n=a(1),r=a.n(n),o=a(47),s=a.n(o),i=a(11),c=a(137),l=a(138),u=a(139),d=a(8),m=a(31),h=m.a.create({main:{padding:"15px 0"}}),p=a(136),g="PUSH_MESSAGES",f="REMOVE_ALL_MESSAGES",b="UPDATE_MESSAGES",v="SAVE_DRAFT",y="SEND_DRAFT_MESSAGE";function w(e){return{type:v,payload:{message:e}}}var O="ADD_CHAT",j="REMOVE_CHAT";var E="CREATE_REWIND_POINT",k="REMOVE_REWIND_POINT",S="SELECT_REWIND_POINT",I="UPDATE_REWIND_POINTS";var T,D=["height","color","weight"],C="name",M="table",x=a(10),F=a(18),R=a(15),_=a(13),N=a(3),A=a(14),P=a(123),V=a(124),W=a(125),B=a(126),G=a(120),U=a(121),H=a(122),q=a(117),Y=a(71),z=a(48),L=a.n(z),J=a(55),K=a.n(J),X=a(7),$={showOnGameControlCreateChats:!0,addChatIdToChatFromArray:!0,addChatIdToChatToArray:!0,preFillFrom:!1},Q=[{chatId:"red",label:"Red Chat",options:Object(X.a)({},$)},{chatId:"blue",label:"Blue Chat",options:Object(X.a)({},$)},{chatId:"white",label:"White Chat",options:Object(X.a)({},$,{addChatIdToChatToArray:!1,preFillFrom:!0})}],Z=function(){return Q.filter(function(e){return e.options.showOnGameControlCreateChats})},ee=Q,te=a(118),ae=a(119),ne=a(140),re=function(e){var t=e.createRewindPoint,a=r.a.createRef();return r.a.createElement(q.a,null,r.a.createElement("form",{onSubmit:function(e){e.preventDefault(),a.current.value&&a.current.value.length&&(t(a.current.value),a.current.value="")}},r.a.createElement(te.a,null,r.a.createElement(ae.a,{innerRef:a,placeholder:"New rewind point"}),r.a.createElement(ne.a,{addonType:"append"},r.a.createElement(Y.a,{color:"warning"},"Create")))))},oe=m.a.create({main:{padding:"15px 0"},hide:{display:"none"},createMessage:{display:"none"},createMessageShow:{display:"block"}}),se=function(e){var t=e.rewinds,a=(e.removeRewindPoint,e.selectRewindPoint);return r.a.createElement(G.a,{className:Object(d.css)(!t.length&&oe.hide)},r.a.createElement("p",null,"Rewind Points:"),r.a.createElement(U.a,null,t.map(function(e,t){var n=e.doc;return r.a.createElement(H.a,{key:t,tag:"button",active:n.active,onClick:function(){a(n._id)}},n.name)})))},ie=Object(i.b)(function(e){return{rewinds:e.rewindPoints.points,active:e.rewindPoints.activeRewind}},function(e){return{removeRewindPoint:function(t){e({type:k,payload:{id:t}})},selectRewindPoint:function(t){e({type:S,payload:{id:t}})}}})(se),ce=function(e){function t(e,a){var n;return Object(x.a)(this,t),(n=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).newMessageForm=n.newMessageForm.bind(Object(N.a)(n)),n.closeMessageForm=n.closeMessageForm.bind(Object(N.a)(n)),n.injectForm=n.injectForm.bind(Object(N.a)(n)),n.generateMessages=n.generateMessages.bind(Object(N.a)(n)),n.editor=null,n.editorRef=r.a.createRef(),n.state={activeSchema:null,createChats:Z()},n}return Object(A.a)(t,e),Object(F.a)(t,[{key:"generateMessages",value:function(e){var t=this;this.props.createMessages(Array.apply(null,Array(e)).map(function(){var e=t.props.messageTypes[Math.floor(Math.random()*t.props.messageTypes.length)];return e.required.reduce(function(t,a){var n="",r=e.properties[a].enum;if(Array.isArray(r)&&r.length)n=r[Math.floor(Math.random()*r.length)];else if("color"===e.properties[a].format)n="#"+Math.floor(16777215*Math.random()).toString(16);else switch(e.properties[a].type){case"integer":n=Math.floor(999*Math.random());break;case"string":n=K()({count:1});break;default:n=e.properties[a].default||K()({count:1})}return t[a]=n,t},{})}))}},{key:"newMessageForm",value:function(e){if(this.state.activeSchema!==e.target.name){this.editor&&this.editor.destroy(),this.setState({activeSchema:e.target.name});var t=this.props.messageTypes[e.target.name];t.properties.from.enum=t.properties.from.enum.sort(function(e,t){return"white"===e?-1:"white"===t?1:0}),this.editor=new L.a(this.editorRef.current,{schema:t,theme:"bootstrap4"})}else this.closeMessageForm()}},{key:"closeMessageForm",value:function(){this.editor.destroy(),this.setState({activeSchema:null})}},{key:"injectForm",value:function(){this.editor.validate().length||(this.props.createMessages([this.editor.getValue()]),this.closeMessageForm())}},{key:"render",value:function(){var e=this;return r.a.createElement("div",{className:Object(d.css)(oe.main)},r.a.createElement(P.a,{className:"main"},r.a.createElement(V.a,{md:4},r.a.createElement(W.a,null,r.a.createElement(B.a,null,"Game Control"),r.a.createElement(G.a,null,r.a.createElement("p",null,"Inject Messages:"),r.a.createElement(U.a,null,this.props.messageTypes.map(function(t,a){return r.a.createElement(H.a,{key:a,tag:"button",active:a===parseInt(e.state.activeSchema),onClick:e.newMessageForm,name:a},t.title)}))),!!this.state.createChats.length&&r.a.createElement(G.a,null,r.a.createElement("p",null,"Create chats:"),r.a.createElement(U.a,null,this.state.createChats.map(function(t,a){var n=e.props.chats.includes(t.chatId);return r.a.createElement(H.a,{key:a,tag:"button",active:n,onClick:function(){n?e.props.removeChat(t.chatId):e.props.createChat(t)}},t.label)}))),r.a.createElement(re,{createRewindPoint:this.props.createRewindPoint}),r.a.createElement(ie,null),r.a.createElement(q.a,null,r.a.createElement(Y.a,{block:!0,color:"success",onClick:function(){e.generateMessages(50)}},"Generate 50 Messages"),r.a.createElement(Y.a,{block:!0,color:"success",onClick:function(){e.generateMessages(100)}},"Generate 100 Messages"),r.a.createElement(Y.a,{block:!0,color:"success",onClick:function(){e.generateMessages(1e3)}},"Generate 1000 Messages")),r.a.createElement(q.a,null,r.a.createElement(Y.a,{block:!0,color:"danger",onClick:this.props.clearMessages},"Clear Messages")))),r.a.createElement(V.a,{md:8},r.a.createElement("div",{className:Object(d.css)(oe.createMessage,this.state.activeSchema&&oe.createMessageShow)},r.a.createElement(W.a,null,r.a.createElement(G.a,null,r.a.createElement("div",{ref:this.editorRef})),r.a.createElement(q.a,null,r.a.createElement(Y.a,{color:"success",onClick:this.injectForm},"Inject")))))))}}]),t}(n.Component),le=Object(i.b)(function(e){return{messageTypes:e.messageTypes.filter(function(e){return D.includes(e.scheme)}),chats:e.chats.map(function(e){return e&&e.id})}},function(e){return{createMessages:function(t){e(function(e){return{type:g,payload:{messages:e}}}(t))},clearMessages:function(){e({type:f})},createChat:function(t){e(function(e){var t=e.chatId,a=e.label;return{type:O,payload:{chat:{id:t,label:a}}}}(t))},removeChat:function(t){e({type:j,payload:t})},createRewindPoint:function(t){e(function(e,t){return{type:E,payload:{name:e,db:t}}}(t,"messages"))}}})(ce),ue=m.a.create({chatItem:{paddingBottom:"15px"}}),de=d.StyleSheet.create({main:{height:"320px",position:"relative",paddingTop:"0.1px",":after":{content:'""',display:"block",position:"absolute",width:"100%",height:"20px",top:"100%",background:"linear-gradient(to bottom, rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%)",left:"0"},":before":{content:'""',display:"block",position:"absolute",width:"100%",height:"20px",bottom:"100%",left:"0",zIndex:"2",background:"linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%)"}},container:{position:"absolute",maxHeight:"100%",height:"auto",left:"0",bottom:"0",width:"100%"},item:{display:"inline-block",verticalAligin:"top",maxWidth:"100%"},scrolContent:{padding:"20px"},badge:{maxWidth:"100%",fontSize:"16px",lineHeight:"20px",padding:"5px 15px",borderRadius:"15px 0 15px 15px",position:"relative",overflow:"hidden",display:"inline-block",verticalAligin:"top",opacity:"0.9",color:"#fff",":hover":{opacity:"1"}},badgeLeft:{borderRadius:"0 15px 15px 15px"},badgeBg:{opacity:"0.8",position:"absolute",left:"0",bottom:"0",height:"100%",width:"100%"},message:{position:"relative"},scrollbar:{boxSizing:"content-box",width:"100%",padding:"20px",margin:"-20px 0 0 -20px",position:"relative",height:"100%"}}),me=a(73),he=a.n(me),pe={blue:"bg-primary",gray:"bg-secondary",green:"bg-success",red:"bg-danger",yellow:"bg-warning",black:"bg-dark",white:"bg-white",lightBlue:"bg-info",lightGray:"bg-light",lightBlack:"bg-muted"},ge={transparent:"link",blue:"primary",gray:"secondary",green:"success",red:"danger",yellow:"warning",lightBlue:"info"},fe={blue:"text-primary",gray:"text-secondary",green:"text-success",red:"text-danger",yellow:"text-warning",black:"text-dark",white:"text-white",lightBlue:"text-info",lightGray:"text-light",lightBlack:"text-muted"},be=function(){function e(t){Object(x.a)(this,e),this.itemId=t,this.items={},this.itemDefault={},this.global={}}return Object(F.a)(e,[{key:"getGlobalScheme",value:function(){return this.global}},{key:"getItemScheme",value:function(){return Object(X.a)({},this.itemDefault,this.items[this.itemId]||{})}},{key:"getScheme",value:function(){return{item:this.getItemScheme(),global:this.getGlobalScheme()}}}]),e}(),ve=function(e){function t(e){var a;return Object(x.a)(this,t),(a=Object(R.a)(this,Object(_.a)(t).call(this,e))).items={red:{bg:pe.red},blue:{bg:pe.blue}},a.itemDefault={bg:pe.gray,text:fe.white},a}return Object(A.a)(t,e),t}(be),ye=a(56),we=a.n(ye),Oe=function(e){function t(e,a){var r;return Object(x.a)(this,t),(r=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).timeId=null,r.loadTimeId=null,r.loading=!1,r.scrolledDown=!0,r.scrollbar=Object(n.createRef)(),r.loadMoreCount=10,r.getScrollHeight=r.getScrollHeight.bind(Object(N.a)(r)),r.onScrollUp=r.onScrollUp.bind(Object(N.a)(r)),r.onYReachStart=r.onYReachStart.bind(Object(N.a)(r)),r.onYReachEnd=r.onYReachEnd.bind(Object(N.a)(r)),r.scrollToDown=r.scrollToDown.bind(Object(N.a)(r)),r.firstScrolled=!1,r.state={showItemsCount:10},r}return Object(A.a)(t,e),Object(F.a)(t,[{key:"componentWillUnmount",value:function(){clearTimeout(this.loadTimeId)}},{key:"onScrollUp",value:function(){this.scrolledDown=!1}},{key:"onYReachEnd",value:function(){this.scrolledDown=!0}},{key:"onYReachStart",value:function(){var e=this;this.loadTimeId&&clearTimeout(this.loadTimeId),this.loadTimeId=setTimeout(function(){var t=e.getScrollHeight();e.scrolledDown||e.loading||(e.loading=!0,e.setState({showItemsCount:e.state.showItemsCount+e.loadMoreCount}),setTimeout(function(){e.scrollbar.current&&(e.scrollbar.current._container.scrollTop=e.getScrollHeight()-t),e.loading=!1}))})}},{key:"getScrollHeight",value:function(){return this.scrollbar.current?this.scrollbar.current._container.scrollHeight:0}},{key:"scrollToDown",value:function(){var e=this;this.timeId&&clearTimeout(this.timeId),this.timeId=setTimeout(function(){e.scrollbar.current?(e.scrollbar.current._container.scrollTop=e.getScrollHeight(),e.firstScrolled=!0):e.firstScrolled||(e.timeId=setTimeout(function(){e.scrollToDown()},512))})}},{key:"componentWillReceiveProps",value:function(e){if(0!==this.props.messages.length&&e.messages.length>this.state.showItemsCount&&this.props.messages.length<e.messages.length){var t=e.messages.length-this.props.messages.length;this.setState({showItemsCount:this.state.showItemsCount+(t>this.loadMoreCount?this.loadMoreCount:t)})}this.scrollToDown()}},{key:"renderItem",value:function(e){if(!e)return"";var t=e.from===this.props.chatId,a=new ve(e.from).getItemScheme(),n={};return t&&(n={textAlign:"right"}),r.a.createElement("div",{style:n},r.a.createElement("div",{className:Object(d.css)(de.item)},r.a.createElement("div",{className:Object(d.css)(de.badge,!t&&de.badgeLeft)},r.a.createElement("div",{className:we()(Object(d.css)(de.badgeBg),a.bg)}),r.a.createElement("div",{className:we()(Object(d.css)(de.message),a.text)},Object.keys(e).map(function(t){return"_"!==t.charAt(0)&&e[t]&&r.a.createElement("div",{key:t},r.a.createElement("strong",null,t,":")," ",e[t])})))))}},{key:"render",value:function(){var e=this;return r.a.createElement("div",{className:Object(d.css)(de.main)},r.a.createElement("div",{className:Object(d.css)(de.scrollbar)},r.a.createElement(he.a,{ref:this.scrollbar,onYReachEnd:this.onYReachEnd,onScrollUp:this.onScrollUp,onYReachStart:this.onYReachStart,suppressScrollX:!0,className:Object(d.css)(de.container),contentClassName:Object(d.css)(de.scrolContent)},r.a.createElement("div",{className:Object(d.css)(de.scrolContent)},this.props.messages.slice(Math.max(this.props.messages.length-this.state.showItemsCount,0)).map(function(t,a){return r.a.createElement("div",{key:a},e.renderItem(t.doc))})))))}}]),t}(n.Component),je=Object(i.b)(function(e,t){var a=t.chatId;return{messages:e.messages&&Array.isArray(e.messages[a])?e.messages[a]:[],chatId:a}},function(e){return{}})(Oe),Ee=a(6),ke=a.n(Ee),Se=function(e){function t(e){var a;return Object(x.a)(this,t),(a=Object(R.a)(this,Object(_.a)(t).call(this,e))).items={red:{bg:pe.red,text:fe.white},blue:{bg:pe.blue,text:fe.white}},a.itemDefault={bg:pe.lightGray,text:fe.black,btn:ge.gray},a.global={body:pe.white,footer:pe.light,tab:pe.white,activeTab:ke()(pe.blue,fe.white)},a}return Object(A.a)(t,e),t}(be),Ie=a(50),Te=a(74);try{T=a(102)}catch(qt){T={}}T=Object(X.a)({},Te,T);var De=Object(X.a)({},T),Ce=function(e,t,a){if(!T[e]&&!a)return new Ie.a(e);a||(a={});var n=T[e]?Object(X.a)({},T[e],a):a,r=new Ie.a(n.name||e);if(n.remote&&t){var o=new Ie.a(n.remote);r.replicate.to(o,{live:n.live,retry:n.retry}).on("complete",function(e){console.log("complete",e)}),r.replicate.from(o,{live:n.live,retry:n.retry}).on("complete",function(e){console.log("complete from",e)})}return r},Me={};ee.forEach(function(e){var t=e.chatId;Me[t]={map:'function (doc) { if(doc.to === "'.concat(t,'" && doc.draft === false || doc.from === "').concat(t,'") emit(doc.id); }')}});var xe={messages:Me},Fe=function e(t,a,n){var r=a.split("/")[0];return t.query(a,n).catch(function(o){if(!xe[r])throw new Error("View "+r+" is not defined.");if(404===o.status)return t.put({_id:"_design/"+r,views:xe[r]}).then(function(){return e(t,a,n)})})},Re={cloneFilter:"function (doc) { return !doc._deleted; }"};ee.forEach(function(e){var t=e.chatId;Re[t]='function (doc) { return doc.to === "'.concat(t,'" && doc.draft === false || doc.from === "').concat(t,'"; }')});var _e={messages:Re},Ne="filter",Ae=d.StyleSheet.create({label:{position:"absolute",top:0,right:0},labelContainer:{position:"relative",width:"100%"},labelButton:{paddingRight:"0 !important",paddingLeft:"0 !important"}}),Pe=function(e){var t=e.colorScheme,a=e.button,n=e.children,o=e.chatId,s=e.defaultMessageType,i=e.createDraft;return r.a.createElement(B.a,{className:t.item.bg},r.a.createElement("div",{className:Object(d.css)(Ae.labelContainer)},r.a.createElement("div",{className:Object(d.css)(Ae.label)},r.a.createElement(Y.a,{color:"link",className:Object(d.css)(Ae.labelButton)},r.a.createElement("strong",{className:t.item.text},n)))),a&&s&&r.a.createElement(Y.a,{color:t.item.btn,onClick:function(){var e={};s.required.forEach(function(t){var a="",n=s.properties[t].enum;Array.isArray(n)&&n.length?a="from"===t&&n.includes(o)?o:s.properties[t].default?s.properties[t].default:n[0]:s.properties[t].default&&(a=s.properties[t].default),e[t]=a}),i(e)}},a))};Pe.defaultValues={button:"",children:""};var Ve=Pe,We=Object(i.b)(function(e){return{defaultMessageType:e.messageTypes.find(function(e){return e.scheme===C})}},function(e){return{createDraft:function(t){e(w(t))}}})(Ve),Be=a(127),Ge=a(128),Ue=a(129),He=a(130),qe=a(131),Ye=a(132),ze=a(133),Le=a(134),Je=a(135),Ke=a(27),Xe=a(30),$e=function(e){function t(e,a){var n;return Object(x.a)(this,t),(n=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).initForm=n.initForm.bind(Object(N.a)(n)),n.submitForm=n.submitForm.bind(Object(N.a)(n)),n.getFormFilteredData=n.getFormFilteredData.bind(Object(N.a)(n)),n.editor=null,n.editorBox=r.a.createRef(),n.hiddenAutofillKeys=["draft","_id","_rev","from","test"],n}return Object(A.a)(t,e),Object(F.a)(t,[{key:"componentDidMount",value:function(){this.initForm()}},{key:"componentWillReceiveProps",value:function(e){this.editor&&this.editor.setValue(this.getFormFilteredData(e.form,e.message).values)}},{key:"getFormFilteredData",value:function(e,t){var a=Object(X.a)({},e,{required:["_id"].concat(Object(Xe.a)(e.required)),properties:Object(X.a)({},e.properties)}),n=Object(X.a)({},t);return this.hiddenAutofillKeys.forEach(function(e){var t=a.required.indexOf(e);t>-1&&a.required.splice(t,1),a.properties[e]&&delete a.properties[e],n[e]&&delete n[e]}),{form:a,values:n}}},{key:"initForm",value:function(){var e=this,t=this.getFormFilteredData(this.props.form,this.props.message);this.editor=new L.a(this.editorBox.current,{schema:t.form,theme:"bootstrap4"}).setValue(t.values);var a=function(t){e.editor.editors.hasOwnProperty(t)&&"root"!==t&&e.editor.watch(t,function(a){e.props.saveDraft(Object(X.a)({},e.props.message,e.editor.getValue(),Object(Ke.a)({},t.replace("root.",""),e.editor.getEditor(t).getValue())))})};for(var n in this.editor.editors)a(n)}},{key:"submitForm",value:function(){this.editor.validate().length||this.props.sendDraftMessage(Object(X.a)({},this.props.message,this.editor.getValue()))}},{key:"render",value:function(){return r.a.createElement("div",{className:"messageEdit"},r.a.createElement("div",{ref:this.editorBox}),r.a.createElement(Y.a,{onClick:this.submitForm},this.props.button))}}]),t}(n.Component),Qe=function(e){function t(e,a){var n;return Object(x.a)(this,t),(n=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).renderDropdown=n.renderDropdown.bind(Object(N.a)(n)),n.toggle=n.toggle.bind(Object(N.a)(n)),n.toggleDropdown=n.toggleDropdown.bind(Object(N.a)(n)),n.renderTabs=n.renderTabs.bind(Object(N.a)(n)),n.showDropdownAfter=3,n.state={activeDraft:e.messages.length-1,dropdownOpen:!1},n}return Object(A.a)(t,e),Object(F.a)(t,[{key:"componentWillReceiveProps",value:function(e){this.props.messages.length!==e.messages.length&&this.toggle(e.messages.length-1)}},{key:"toggle",value:function(e){this.setState({activeDraft:e})}},{key:"toggleDropdown",value:function(){this.setState({dropdownOpen:!this.state.dropdownOpen})}},{key:"renderDropdown",value:function(){var e=this;return r.a.createElement(Be.a,{isOpen:this.state.dropdownOpen,toggle:this.toggleDropdown},r.a.createElement(Ge.a,{caret:!0,className:this.props.colorScheme.global.activeTab},this.props.messages[this.state.activeDraft].doc.title||"Draft ".concat(this.state.activeDraft)),r.a.createElement(Ue.a,{right:!0},this.props.messages.map(function(t,a){return r.a.createElement(He.a,{key:a,className:e.state.activeDraft===a?e.props.colorScheme.global.activeTab:"",onClick:function(){e.toggle(a)}},t.doc.title||"Draft ".concat(a))})))}},{key:"renderTabs",value:function(){var e=this;return this.props.messages.length<2?r.a.createElement("div",null):r.a.createElement(qe.a,{tabs:!0},this.props.messages.map(function(t,a){return r.a.createElement(Ye.a,{key:a},r.a.createElement(ze.a,{className:e.state.activeDraft===a?e.props.colorScheme.global.activeTab:e.props.colorScheme.global.tab,onClick:function(){e.toggle(a)}},t.doc.title?t.doc.title:"Draft ".concat(a+1)))}))}},{key:"render",value:function(){var e=this;return r.a.createElement(q.a,{className:this.props.colorScheme.global.footer},this.props.messages.length>0&&r.a.createElement(Le.a,{activeTab:this.state.activeDraft+""},this.props.messages.length>this.showDropdownAfter?this.renderDropdown():this.renderTabs(),this.props.messages.map(function(t,a){return r.a.createElement(Je.a,{key:a,tabId:a+""},r.a.createElement($e,{message:t.doc,button:e.props.button,form:e.props.form,saveDraft:e.props.saveDraft,sendDraftMessage:e.props.sendDraftMessage}))})))}}]),t}(n.Component),Ze=Object(i.b)(function(e,t){var a=t.chatId;return{messages:e.messages&&Array.isArray(e.messages[a])?e.messages[a].filter(function(e){return e.doc.draft}):[],form:Object(X.a)({},e.messageTypes.find(function(e){return e.scheme===C}),{format:M})}},function(e){return{sendDraftMessage:function(t){e({type:y,payload:{message:t}})},saveDraft:function(t){e(w(t))}}})(Qe),et=function(e){function t(e,a){var n;return Object(x.a)(this,t),(n=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).updateState=function(e){n.changeTimer&&clearTimeout(n.changeTimer),n.changeTimer=setTimeout(function(){console.log(n.db),Fe(n.db,"messages/"+n.props.chatId,{include_docs:!0,filter:Ne+"messages/"+n.props.chatId}).then(function(t){var a=t.rows;console.log(a),n.props.updateMessages(a||[],n.props.chatId),"function"===typeof e&&e()})},n.changeTime)},n.changeTimer=null,n.changeTime=128,n.updateState=n.updateState.bind(Object(N.a)(n)),n.initDatabase=n.initDatabase.bind(Object(N.a)(n)),n.dbName="messages",n.db=null,n.changes=null,n.state={colorScheme:new Se(e.chatId).getScheme()},n}return Object(A.a)(t,e),Object(F.a)(t,[{key:"componentWillMount",value:function(){this.initDatabase(this.props.chatId,this.props.activeRewind)}},{key:"componentWillReceiveProps",value:function(e){this.initDatabase(e.chatId,e.activeRewind)}},{key:"initDatabase",value:function(e,t){var a,n,r=this,o=t&&t.doc.local!==this.dbName,s=!this.db;(this.props.chatId!==e||o||s||this.props.activeRewind&&!t)&&(this.changes&&this.changes.cancel(),o?(this.dbName=t.doc.local,this.db=Ce(this.dbName,!1,Object(X.a)({},De.messages,{name:t.doc.local,remote:De.messages.remote?De.messages.remote.replace("messages",this.dbName):null})),s=!0):(s||"messages"!==this.dbName)&&(s=!0,this.dbName="messages",this.db=Ce(this.dbName)),s&&this.updateState(),this.changes=(a=this.db,n="messages/"+e,a.changes({since:"now",live:!0,include_docs:!0,filter:Ne+n})).on("change",function(){r.updateState()}),this.setState({colorScheme:new Se(e).getScheme()}))}},{key:"componentWillUnmount",value:function(){this.changes.cancel(),clearTimeout(this.changeTimer)}},{key:"render",value:function(){return r.a.createElement(W.a,null,r.a.createElement(We,{colorScheme:this.state.colorScheme,button:"Add >>",chatId:this.props.chatId},this.props.label),r.a.createElement(G.a,{className:this.state.colorScheme.global.body},r.a.createElement(je,{chatId:this.props.chatId})),r.a.createElement(Ze,{colorScheme:this.state.colorScheme,button:"Send",chatId:this.props.chatId}))}}]),t}(n.Component),tt=Object(i.b)(function(e){return{activeRewind:e.rewindPoints.points.filter(function(e){return e.doc.active})[0]}},function(e){return{updateMessages:function(t,a){e(function(e,t){return{type:b,payload:{messages:e,chatId:t}}}(t,a))}}})(et),at=12,nt=6,rt=4,ot=function(e){var t=e.chats,a=e.form;return r.a.createElement(P.a,null,t.map(function(e,t){return e&&r.a.createElement(V.a,{xs:at,sm:nt,md:rt,key:t},r.a.createElement("div",{className:Object(d.css)(ue.chatItem)},r.a.createElement(tt,{chatId:e.id,label:e.label,form:a})))}))},st=Object(i.b)(function(e){return{chats:e.chats,form:Object(X.a)({},e.messageTypes.find(function(e){return e.scheme===C}),{format:M})}},function(e){return{}})(ot),it=function(){return r.a.createElement(p.a,{fluid:!0},r.a.createElement("div",{className:Object(d.css)(h.main)},r.a.createElement(st,null),r.a.createElement(le,null)))},ct=function(e){function t(e,a){var n;return Object(x.a)(this,t),(n=Object(R.a)(this,Object(_.a)(t).call(this,e,a))).check=n.check.bind(Object(N.a)(n)),n.messagesFiltersInitialized=!1,n.messagesViewsInitialized=!1,n.state={done:!1},n}return Object(A.a)(t,e),Object(F.a)(t,[{key:"check",value:function(){this.messagesFiltersInitialized&&this.messagesViewsInitialized&&this.setState({done:!0})}},{key:"componentWillMount",value:function(){this.checkMessages()}},{key:"checkMessages",value:function(){this.checkFilter(_e,Ne,Object.keys(_e)),this.checkView(xe,Object.keys(xe))}},{key:"checkFilter",value:function(e,t,a,n){var r=this;if(n||(n=0),!a.length||a.length<=n)return this.messagesFiltersInitialized=!0,this.check(),!1;var o=Ce(a[n],!1,{live:!1}),s="_design/"+t+a[n];o.get(s).then(function(i){var c=!0;i.filters?Object.keys(e[a[n]]).forEach(function(t){i.filters[t]&&e[a[n]][t]===i.filters[t]||(c=!1)}):c=!1,c?r.checkFilter(e,t,a,n+1):(console.log("Updateing Filters ".concat(s)),o.put(Object(X.a)({},i,{filters:e[a[n]]})).then(function(){console.log("Updateing Filters ".concat(s," (success)")),r.checkFilter(e,t,a,n+1)}))}).catch(function(i){404===i.status&&(console.log("Creating Filters ".concat(s)),o.put({_id:s,filters:e[a[n]]}).then(function(){console.log("Creating Filters ".concat(s," (success)")),r.checkFilter(e,t,a,n+1)}))})}},{key:"checkView",value:function(e,t,a){var n=this;if(a||(a=0),!t.length||t.length<=a)return this.messagesViewsInitialized=!0,this.check(),!1;var r="_design/"+t[a],o=Ce(t[a],!1,{live:!1});o.get(r).then(function(s){var i=!0;s.views?Object.keys(e[t[a]]).forEach(function(n){s.views[n]&&e[t[a]][n].map===s.views[n].map||(i=!1)}):i=!1,i?n.checkView(e,t,a+1):(console.log("Updateing Views ".concat(r)),o.put(Object(X.a)({},s,{views:e[t[a]]})).then(function(){console.log("Updateing Views ".concat(r," (success)")),n.checkView(e,t,a+1)}))}).catch(function(s){var i=s.status;console.log("test",i),404===i&&(console.log("Creating Views ".concat(r)),o.put({_id:r,views:e[t[a]]}).then(function(){console.log("Views Filters ".concat(r," (success)")),n.checkView(e,t,a+1)}))})}},{key:"render",value:function(){return r.a.createElement("div",null,this.state.done&&this.props.children)}}]),t}(n.Component),lt=function(e){var t=e.initStore,a=e.children;return t(),r.a.createElement("div",null,a)},ut=Object(i.b)(function(e){return{}},function(e){return{initStore:function(){e({type:"INIT",payload:{}})}}})(lt),dt=function(e){var t=e.store;return r.a.createElement(i.a,{store:t},r.a.createElement(ut,null,r.a.createElement(ct,null,r.a.createElement(c.a,null,r.a.createElement(l.a,null,r.a.createElement(u.a,{exact:!0,path:"/",component:it}))))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));a(104),a(105),a(106);var mt=a(24),ht=a(28),pt=[],gt=Ce("chats"),ft=Object(ht.persistentReducer)(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:pt,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case O:return[].concat(Object(Xe.a)(e),[t.payload.chat]);case j:return e.filter(function(e){return e.id!==t.payload});default:return e}},{db:gt,name:"chats"}),bt={type:"object",format:"grid",required:["from","to","title"],properties:{from:{type:"string",enum:Q.filter(function(e){return e.options.addChatIdToChatFromArray}).map(function(e){return e.chatId})},to:{type:"string",enum:Q.filter(function(e){return e.options.addChatIdToChatToArray}).map(function(e){return e.chatId})},title:{type:"string",description:"Title for this message"}}},vt=[{scheme:"height",title:"PersonHeight",properties:{height:{type:"integer",default:12}}},{scheme:"weight",title:"PersonWeight",properties:{weight:{type:"integer",default:12}}},{scheme:"color",title:"PersonColor",properties:{color:{type:"string",format:"color"}}},{scheme:"name",title:"PersonName",properties:{name:{type:"string",format:"string"}}}],yt=function(){return vt.map(function(e){return Object(X.a)({},bt,{scheme:e.scheme,title:e.title,properties:Object(X.a)({},bt.properties,e.properties),required:[].concat(Object(Xe.a)(bt.required),[e.scheme])})})}(),wt=Ce("message-types"),Ot=Object(ht.persistentReducer)(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:yt;return(arguments.length>1?arguments[1]:void 0).type,e},{db:wt,name:"message-types"}),jt=Ce("messages",!0),Et={},kt=function(e){return(new Date).toISOString()+"-"+(e||"0")},St=function(e){return e.map(function(e,t){return Object(X.a)({},e,{_id:kt(t),draft:!1})})},It=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Et,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case g:var a=St(t.payload.messages);return 1===a.length?jt.put(a[0]):jt.bulkDocs(a),e;case f:return jt.allDocs().then(function(e){return Promise.all(e.rows.map(function(e){return-1===e.id.search("_design")&&jt.remove(e.id,e.value.rev)}))}),{};case b:return Object(X.a)({},e,Object(Ke.a)({},t.payload.chatId,t.payload.messages));case v:var n=Object(X.a)({},St([t.payload.message])[0],{draft:!0});return t.payload.message._id&&(n._id=t.payload.message._id),t.payload.message._rev&&(n._rev=t.payload.message._rev),jt.put(n),e;case y:return jt.get(t.payload.message._id).then(function(e){jt.bulkDocs([Object(X.a)({},St([t.payload.message])[0],{_rev:""}),Object(X.a)({},e,{_deleted:!0})])}),e;default:return e}},Tt={points:[],activeRewind:null},Dt=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Tt,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case I:return Object(X.a)({},e,{points:t.payload.points});default:return e}},Ct=Object(mt.combineReducers)({chats:ft,messageTypes:Ot,messages:It,rewindPoints:Dt}),Mt=a(77),xt=a(78),Ft=function(e,t){return new Promise(function(a,n){var r=Nt(),o=t.name+"-rewind-"+r,s=Ce(o);s.replicate.from(e,{live:!1,retry:!1,filter:"filtermessages/cloneFilter"}).on("complete",function(e){if(console.log("success",e),t.remote){var n=t.remote+"-rewind-"+r;Ce(n).replicate.from(s,{live:!1,retry:!1}).on("complete",function(e){a({_id:r,local:o,remote:!0})}).on("error",function(e){console.log("Error on remote database sync, created only local db"),console.log(e),a({_id:r,local:o,remote:!1})})}else a({_id:r,local:o,remote:!1})}).on("error",function(e){console.log("Error on local db clone"),console.log(e),n()})})},Rt=function(e,t){_t(e,t)},_t=function(e,t){e.allDocs({include_docs:!0}).then(function(e){var a=e.rows;console.log(a),t.dispatch({type:I,payload:{points:a}})})},Nt=function(e){return(new Date).toISOString()+"-"+(e||"0")},At=function(e){return Object(X.a)({},e,{active:!1,roomId:""})},Pt=function(e,t,a,n,r){switch(a.type){case"INIT":Rt(n,e);break;case E:Ft(r,De.messages).then(function(t){n.put(Object(X.a)({},At(a.payload),t)).then(function(t){_t(n,e)})});break;case S:n.allDocs({include_docs:!0}).then(function(t){var r=t.rows.filter(function(e){return e.doc.active||e.doc._id===a.payload.id}).map(function(e){return Object(X.a)({},e.doc,{active:!e.doc.active})});n.bulkDocs(r).then(function(){_t(n,e)})});break;default:return!1}return!0},Vt=Ce("rewind-points"),Wt=Ce("messages",!1),Bt=function(e){return function(t){return function(a){Pt(e,t,a,Vt,Wt)||t(a)}}},Gt=Object(mt.applyMiddleware)(Mt.a,Bt),Ut=Ce("main"),Ht=Object(xt.composeWithDevTools)(Gt,Object(ht.persistentStore)({db:Ut}))(mt.createStore)(Ct);s.a.render(r.a.createElement(dt,{store:Ht}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},74:function(e){e.exports={main:{name:"main",remote:null,live:!1,retry:!1},messages:{name:"messages",remote:"http://localhost:8080/db/messages",live:!0,retry:!1},"message-types":{name:"message-types",remote:null,live:!1,retry:!1},"rewind-points":{name:"rewind-points",remote:"http://localhost:8080//db/rewind-points",live:!0,retry:!1}}},79:function(e,t,a){e.exports=a(115)}},[[79,1,2]]]);
//# sourceMappingURL=main.bad033bd.chunk.js.map